#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

REMOTE_CONFIG_DIR="$HOME/remoteconfig" # Assume remote user and local user has same $HOME
LOCAL_CONFIG_DIR="$HOME/config/remoteconfig"

if ! rsync --rsh="ssh -oBatchMode=yes" --copy-links -r "$LOCAL_CONFIG_DIR/" "$@:${REMOTE_CONFIG_DIR}" > /dev/null 2>&1; then
    ssh-copy-id "$@"
    rsync --copy-links -r "$LOCAL_CONFIG_DIR/" "$@:${REMOTE_CONFIG_DIR}" > /dev/null 2>&1
fi
ssh "$@" -t "sudo -i REMOTE_CONFIG_DIR=${REMOTE_CONFIG_DIR} bash --rcfile ${REMOTE_CONFIG_DIR}/bashrc -O globstar"
